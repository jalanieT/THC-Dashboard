<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Tracking</title>
    <link rel="icon" href="https://raw.githubusercontent.com/jantaw/THC-Dashboard/f7bd6b457a79a29fa774dec0861c650c30b90115/Elements/thc.png" type="image/png">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6fc;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
            background-color: #f4f9fd;
            color: #21b39b;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header img {
            height: 50px;
            width: auto;
        }

        .header h1 {
            font-size: 2em;
            margin: 0;
            white-space: nowrap;
        }

        .menu {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 1.2em;
        }

        .menu-item {
            position: relative;
        }

        .menu-item:hover .dropdown {
            display: block;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #ffffff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            z-index: 100;
        }

        .dropdown a {
            display: block;
            padding: 10px;
            text-decoration: none;
            color: #0077b6;
        }

        .dropdown a:hover {
            background-color: #f4f9fd;
        }

        .button {
            padding: 8px 16px;
            text-decoration: none;
            color: #ffffff;
            background-color: #21b39b;
            border: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .button:hover {
            background-color: #1a8a76;
        }

        .container {
            margin: 120px auto;
            padding: 20px;
            max-width: 90%;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            color: #21b39b;
        }

        .filters {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .dropdown {
            padding: 8px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        table th {
            background-color: #f4f9fd;
            color: #0077b6;
        }

        .spinner {
            display: none;
            margin: 0 auto;
            border: 8px solid rgba(0, 0, 0, 0.1);
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/jalanieT/dashboard/1e2fab70d1bf84a40d976c5adea383424424d9ce/Assets/Total-Health-Choice_Logo-RGB.png" alt="Total Health Choice Logo">
            <h1>Appointment Tracking Report</h1>
        </div>
        <div class="menu">
            <div class="menu-item">
                <span>Finance</span>
                <div class="dropdown">
                    <a href="#">Staff Payroll</a>
                    <a href="#">Revenue Report</a>
                    <a href="#">Aged Debtor</a>
                    <a href="#">Monthly Business Scorecard</a>
                </div>
            </div>
            <div class="menu-item">
                <span>Performance</span>
                <div class="dropdown">
                    <a href="#">Staff Performance</a>
                    <a href="#">Net Promoter Score</a>
                    <a href="#">Staff Profitability</a>
                    <a href="#">Staff Efficiency</a>
                </div>
            </div>
            <div class="menu-item">
                <span>Operations</span>
                <div class="dropdown">
                    <a href="#">Referral Summary</a>
                    <a href="#">Client Bookings</a>
                    <a href="#">Appointment Tracking</a>
                </div>
            </div>
            <a href="#" class="button">My Dashboard</a>
        </div>
    </div>

    <div class="container">
        <h2>Appointment Tracking Report</h2>
        <div class="filters">
            <select id="categoryDropdown" class="dropdown">
                <option value="">All Categories</option>
            </select>
            <select id="yearDropdown" class="dropdown">
                <option value="">All Years</option>
            </select>
        </div>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Category</th>
                    <!-- Dynamic year columns will be added here -->
                    <th>Grand Total</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr id="totalRow">
                    <th>Total</th>
                    <!-- Dynamic total columns will be added here -->
                    <th>0</th>
                </tr>
            </tfoot>
        </table>
        <div class="spinner" id="loadingSpinner"></div>
    </div>

    <script>
        const scriptAppURL = "https://script.google.com/macros/s/AKfycbz7jNT_5DSi3EJmCXCDAQjmdGEV9rv_aDISlnaUGK1FnLRGLswZxeJqvmkgPAEKp04/exec";

        async function fetchData(category = "", year = "") {
            const spinner = document.getElementById('loadingSpinner');
            const tableBody = document.querySelector('#dataTable tbody');
            const tableHead = document.querySelector('#dataTable thead tr');
            const totalRow = document.getElementById('totalRow');

            tableBody.innerHTML = ''; // Clear existing data
            totalRow.innerHTML = '<th>Total</th>'; // Reset total row
            spinner.style.display = 'block'; // Show spinner

            try {
                const response = await fetch(`${scriptAppURL}?category=${category}&year=${year}`);
                const data = await response.json();
                console.log("Fetched Data:", data);

                if (data && data.values && Array.isArray(data.values)) {
                    const categories = new Map();
                    const years = new Set();
                    const totals = {};

                    // Process data
                    data.values.forEach(row => {
                        const category = row[15]; // Column P
                        const serviceDate = new Date(row[2]); // Column C
                        const year = serviceDate.getFullYear();

                        years.add(year);
                        totals[year] = (totals[year] || 0) + 1;

                        if (!categories.has(category)) {
                            categories.set(category, { total: 0, yearCounts: {} });
                        }

                        const categoryData = categories.get(category);
                        categoryData.total += 1;
                        categoryData.yearCounts[year] = (categoryData.yearCounts[year] || 0) + 1;
                    });

                    // Update table header with dynamic year columns
                    tableHead.innerHTML = '<th>Category</th>';
                    Array.from(years).sort().forEach(year => {
                        const th = document.createElement('th');
                        th.textContent = year;
                        tableHead.appendChild(th);
                    });
                    tableHead.innerHTML += '<th>Grand Total</th>';

                    // Populate main table body
                    categories.forEach((data, category) => {
                        const tr = document.createElement('tr');
                        let yearCells = '';
                        Array.from(years).sort().forEach(year => {
                            yearCells += `<td>${(data.yearCounts[year] || 0).toLocaleString()}</td>`;
                        });

                        tr.innerHTML = `<td>${category}</td>${yearCells}<td>${data.total.toLocaleString()}</td>`;
                        tableBody.appendChild(tr);
                    });

                    // Populate total row
                    Array.from(years).sort().forEach(year => {
                        const td = document.createElement('td');
                        td.textContent = (totals[year] || 0).toLocaleString();
                        totalRow.appendChild(td);
                    });

                    const grandTotal = Object.values(totals).reduce((sum, count) => sum + count, 0);
                    const grandTotalCell = document.createElement('td');
                    grandTotalCell.textContent = grandTotal.toLocaleString();
                    totalRow.appendChild(grandTotalCell);
                } else {
                    console.error("Invalid data format:", data);
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            } finally {
                spinner.style.display = 'none'; // Hide spinner
            }
        }

        document.getElementById('categoryDropdown').addEventListener('change', (event) => {
            const category = event.target.value;
            const year = document.getElementById('yearDropdown').value;
            fetchData(category, year);
        });

        document.getElementById('yearDropdown').addEventListener('change', (event) => {
            const year = event.target.value;
            const category = document.getElementById('categoryDropdown').value;
            fetchData(category, year);
        });

        // Initial load
        fetchData();
    </script>
</body>
</html>